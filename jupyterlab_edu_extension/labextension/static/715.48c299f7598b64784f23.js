"use strict";(self.webpackChunkjupyterlab_edu_extension=self.webpackChunkjupyterlab_edu_extension||[]).push([[715],{715:(e,t,s)=>{s.r(t),s.d(t,{default:()=>v});var n=s(827),o=s(389),i=s(247);class a{static initialize(){this.initialized?console.log("[SessionManager] å·²ç¶“åˆå§‹åŒ–éï¼Œè·³é"):(this.initialized=!0,console.group("[SessionManager] åˆå§‹åŒ–"),this.clearStorage(),console.log("èˆŠæœƒè©±å·²æ¸…é™¤"),this.state={sessionId:null,student:null,isLoggedIn:!1,notebookName:null},console.log("ç‹€æ…‹å·²é‡ç½®ç‚ºæœªç™»å…¥:",this.state),console.groupEnd(),this.notifyListeners())}static getSessionId(){return this.state.sessionId}static getStudent(){return this.state.student}static isLoggedIn(){return this.state.isLoggedIn}static getState(){return{...this.state}}static setSession(e,t,s){console.group("[SessionManager] è¨­å®šæœƒè©± (setSession)"),console.log("Session ID:",e),console.log("Student:",t),console.trace("å‘¼å«ä¾†æº"),this.state={sessionId:e,student:t,isLoggedIn:!0,notebookName:s},this.notifyListeners(),console.groupEnd()}static clearSession(){this.state={sessionId:null,student:null,isLoggedIn:!1,notebookName:null},this.notifyListeners(),this.clearStorage()}static subscribe(e){return this.listeners.add(e),e(this.getState()),()=>{this.listeners.delete(e)}}static notifyListeners(){const e=this.getState();this.listeners.forEach(t=>t(e));const t=new CustomEvent("edu-extension:session-change",{detail:e});document.dispatchEvent(t)}static clearStorage(){try{localStorage.removeItem("edu-extension-session")}catch(e){console.warn("[SessionManager] ç„¡æ³•æ¸…é™¤ localStorage:",e)}}static requireLogin(e=!0){if(this.isLoggedIn())return!0;if(e){const e=new CustomEvent("edu-extension:require-login",{detail:{message:"è«‹å…ˆç™»å…¥ä»¥åŸ·è¡Œç¨‹å¼ç¢¼"}});document.dispatchEvent(e)}return!1}}a.state={sessionId:null,student:null,isLoggedIn:!1,notebookName:null},a.listeners=new Set,a.initialized=!1;class r{constructor(e){this.executionMap=new Map,this.attachedPanels=new Set,this.kernelHandlers=new Map,this.apiClient=e}attachToNotebook(e){const t=e.id;if(this.attachedPanels.has(t))return;this.attachedPanels.add(t);const s=e.sessionContext;s.ready.then(()=>{this.setupKernelListeners(s,e.title.label)}),s.kernelChanged.connect(()=>{this.setupKernelListeners(s,e.title.label)}),e.disposed.connect(()=>{this.cleanupSession(s),this.attachedPanels.delete(t)}),console.log("[KernelMonitor] å·²é™„åŠ åˆ° Notebook:",e.title.label)}cleanupSession(e){const t=e.session;if(!t)return;const s=t.id,n=this.kernelHandlers.get(s);if(n&&t.kernel){try{t.kernel.iopubMessage.disconnect(n)}catch(e){}this.kernelHandlers.delete(s)}}setupKernelListeners(e,t){const s=e.session,n=s?.kernel;if(!s||!n)return;this.cleanupSession(e);const o=(e,t)=>{this.handleIOPubMessage(t)};this.kernelHandlers.set(s.id,o),n.iopubMessage.connect(o),console.log(`[KernelMonitor] Kernel ç›£è½å™¨å·²è¨­ç½® (${t})`)}handleIOPubMessage(e){const t=e.header.msg_type,s=e.parent_header?.msg_id;if(s)switch(t){case"execute_input":this.handleExecuteInput(s,e);break;case"stream":this.handleStreamOutput(s,e);break;case"execute_result":this.handleExecuteResult(s,e);break;case"error":this.handleError(s,e);break;case"status":this.handleStatus(s,e)}}handleExecuteInput(e,t){if(this.executionMap.has(e))return void console.warn("[KernelMonitor] é‡è¤‡çš„ execute_inputï¼Œå¯èƒ½æ˜¯é‡è¤‡ç›£è½:",e);const s=t.content,n=s.execution_count||0,o=s.code||"";this.executionMap.set(e,{cellId:e,cellContent:o,executionCount:n,outputs:[],errors:[],startTime:Date.now(),endTime:0})}handleStreamOutput(e,t){const s=this.executionMap.get(e);if(!s)return;const n=t.content.text||"";s.outputs.push(n)}handleExecuteResult(e,t){const s=this.executionMap.get(e);if(!s)return;const n=t.content.data||{};n["text/plain"]&&s.outputs.push(n["text/plain"])}handleError(e,t){const s=this.executionMap.get(e);if(!s)return;const n=t.content,o=`${n.ename||"Error"}: ${n.evalue||""}\n${(n.traceback||[]).join("\n")}`;s.errors.push(o)}async handleStatus(e,t){if("idle"===t.content.execution_state){const t=this.executionMap.get(e);t&&t.cellContent&&(this.executionMap.delete(e),t.endTime=Date.now(),await this.recordExecution(t))}}async recordExecution(e){if(!a.isLoggedIn())return;const t=a.getSessionId(),s=e.endTime-e.startTime,n=e.outputs.join("\n"),o=e.errors.length>0?e.errors.join("\n"):null;try{const i=await this.apiClient.trackExecution({sessionId:t,cellId:e.cellId,cellContent:e.cellContent,executionCount:e.executionCount,output:n.slice(0,1e4),errorOutput:o?o.slice(0,5e3):null,executionTimeMs:s});i.has_error&&i.openai_configured&&o&&t&&this.streamErrorAnalysis(t,e.cellContent,o)}catch(e){if(console.error("[KernelMonitor] è¨˜éŒ„åŸ·è¡Œå¤±æ•—:",e),e.message&&(e.message.includes("NOT_LOGGED_IN")||e.message.includes("è«‹å…ˆç™»å…¥"))){console.warn("[KernelMonitor] åµæ¸¬åˆ°æœƒè©±å¤±æ•ˆï¼ŒåŸ·è¡Œè‡ªå‹•ç™»å‡º"),a.clearSession();const e=new CustomEvent("edu-extension:require-login",{detail:{message:"æ‚¨çš„ç™»å…¥æœƒè©±å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚"}});document.dispatchEvent(e)}}}async streamErrorAnalysis(e,t,s){this.showAnalysisNotification("ğŸ”„ **æ­£åœ¨åˆ†æéŒ¯èª¤...**");const n=document.cookie.split("; ").find(e=>e.startsWith("_xsrf="))?.split("=")[1]||"";try{const o=await fetch("/edu-extension/api/tracking/error-analysis-stream",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":n},body:JSON.stringify({session_id:e,code:t,error:s}),credentials:"same-origin"});if(!o.ok)return void this.showAnalysisNotification("âš ï¸ åˆ†æå¤±æ•—");const i=o.body?.getReader();if(!i)return void this.showAnalysisNotification("âš ï¸ ç„¡æ³•è®€å–ä¸²æµ");const a=new TextDecoder;let r="",l="";for(;;){const{done:e,value:t}=await i.read();if(e)break;r+=a.decode(t,{stream:!0});const s=r.split("\n");r=s.pop()||"";for(const e of s)if(e.startsWith("data: ")){const t=e.slice(6).trim();if("[DONE]"===t)return void(l&&this.showAnalysisNotification(l));try{const e=JSON.parse(t);e.chunk&&(l+=e.chunk,this.showAnalysisNotification(l))}catch{}}}l&&this.showAnalysisNotification(l)}catch(s){console.error("[KernelMonitor] ä¸²æµåˆ†æå¤±æ•—:",s),this.showAnalysisNotification("âš ï¸ åˆ†æå¤±æ•—")}}showAnalysisNotification(e){const t=new CustomEvent("edu-extension:analysis",{detail:{analysis:e}});document.dispatchEvent(t)}static getNotebookContext(e){const t=e.content,s=[];for(let e=0;e<t.widgets.length;e++){const n=t.widgets[e].model;s.push({type:"code"===n.type?"code":"markdown",content:n.sharedModel.getSource()})}return{cells:s,current_cell_index:t.activeCellIndex}}}let l=null,c=null;class d extends i.Widget{constructor(e,t){super(),this.messages=[],this.apiClient=e,this.notebookTracker=t,this.addClass("jp-edu-chatgpt-sidebar"),this.node.innerHTML='\n      <div class="jp-edu-chat-container">\n        <div class="jp-edu-chat-header">\n          <h3>ğŸ¤– AI åŠ©æ•™</h3>\n          <p class="jp-edu-chat-hint">æœ‰ä»»ä½•ç¨‹å¼å•é¡Œéƒ½å¯ä»¥å•æˆ‘ï¼</p>\n        </div>\n        <div class="jp-edu-login-overlay">\n          <div class="jp-edu-login-overlay-content">\n            <p>ğŸ”’ è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨ AI åŠ©æ•™åŠŸèƒ½</p>\n          </div>\n        </div>\n        <div class="jp-edu-chat-messages"></div>\n        <div class="jp-edu-chat-input-area">\n          <textarea \n            class="jp-edu-chat-input" \n            placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."\n            rows="3"\n          ></textarea>\n          <button class="jp-edu-chat-send">ç™¼é€</button>\n        </div>\n      </div>\n    ',this.messagesContainer=this.node.querySelector(".jp-edu-chat-messages"),this.inputElement=this.node.querySelector(".jp-edu-chat-input"),this.sendButton=this.node.querySelector(".jp-edu-chat-send"),this.loginOverlay=this.node.querySelector(".jp-edu-login-overlay"),this.sendButton.addEventListener("click",()=>this.sendMessage()),this.inputElement.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),this.setupGlobalAnalysisListener(),a.subscribe(e=>{this.updateLoginState(e.isLoggedIn)}),this.updateLoginState(a.isLoggedIn()),this.addMessage({role:"assistant",content:"ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ•™ ğŸ“\n\næˆ‘å¯ä»¥å¹«åŠ©ä½ ï¼š\n- è§£é‡‹ç¨‹å¼ç¢¼\n- åˆ†æéŒ¯èª¤è¨Šæ¯\n- å›ç­”ç¨‹å¼è¨­è¨ˆå•é¡Œ\n\næœ‰ä»€éº¼å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ",timestamp:new Date})}setupGlobalAnalysisListener(){c=this,l?console.log("[ChatGPTSidebar] ä½¿ç”¨ç¾æœ‰çš„å…¨åŸŸäº‹ä»¶ç›£è¯å™¨"):(l=e=>{const t=e;if(c&&a.isLoggedIn()){const e=`ğŸ“Š **ç¨‹å¼åŸ·è¡Œåˆ†æ**\n\n${t.detail.analysis}`,s=c.messages[c.messages.length-1];s&&"system"===s.role&&s.content.includes("ç¨‹å¼åŸ·è¡Œåˆ†æ")?(s.content=e,c.updateLastMessage(e)):c.addMessage({role:"system",content:e,timestamp:new Date})}},document.addEventListener("edu-extension:analysis",l),console.log("[ChatGPTSidebar] å…¨åŸŸäº‹ä»¶ç›£è½å™¨å·²è¨­ç½®"))}updateLoginState(e){e?(this.loginOverlay.style.display="none",this.inputElement.disabled=!1,this.sendButton.disabled=!1):(this.loginOverlay.style.display="flex",this.inputElement.disabled=!0,this.sendButton.disabled=!0)}async sendMessage(){if(!a.isLoggedIn())return;const e=this.inputElement.value.trim();if(!e)return;this.inputElement.value="",this.addMessage({role:"user",content:e,timestamp:new Date}),this.setLoading(!0);const t={role:"assistant",content:"",timestamp:new Date};this.messages.push(t),this.renderMessages();try{const s=this.getNotebookContext(),n=a.getSessionId();await this.apiClient.chatStream(n,e,s,e=>{t.content+=e,this.updateLastMessage(t.content)},e=>{console.error("[ChatGPTSidebar] ä¸²æµéŒ¯èª¤:",e),"è«‹å…ˆç™»å…¥"===e?(a.clearSession(),t.content="âš ï¸ æœƒè©±å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚"):t.content=`æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š${e}\n\nè«‹ç¢ºèª OpenAI API å·²æ­£ç¢ºé…ç½®ã€‚`,this.updateLastMessage(t.content)},()=>{t.content||(t.content="ç„¡æ³•å–å¾—å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",this.updateLastMessage(t.content))})}catch(e){console.error("[ChatGPTSidebar] ç™¼é€è¨Šæ¯å¤±æ•—:",e),t.content=`æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š${e.message||e}`,this.updateLastMessage(t.content)}finally{this.setLoading(!1)}}addMessage(e){this.messages.push(e);const t=document.createElement("div");t.className=`jp-edu-chat-message jp-edu-chat-message-${e.role}`;const s="user"===e.role?"ğŸ‘¤":"assistant"===e.role?"ğŸ¤–":"ğŸ“¢",n=this.formatMarkdown(e.content);t.innerHTML=`\n      <div class="jp-edu-message-avatar">${s}</div>\n      <div class="jp-edu-message-content">\n        <div class="jp-edu-message-text">${n}</div>\n        <div class="jp-edu-message-time">${this.formatTime(e.timestamp)}</div>\n      </div>\n    `,this.messagesContainer.appendChild(t),this.scrollToBottom()}formatMarkdown(e){return(e=(e=(e=(e=(e=e.replace(/```(\w+)?\n([\s\S]*?)```/g,"<pre><code>$2</code></pre>")).replace(/`([^`]+)`/g,"<code>$1</code>")).replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/\*([^*]+)\*/g,"<em>$1</em>")).replace(/\n/g,"<br>")).replace(/^## (.+)$/gm,"<h4>$1</h4>")}formatTime(e){return e.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"})}renderMessages(){this.messagesContainer.innerHTML="";for(const e of this.messages){const t=document.createElement("div");t.className=`jp-edu-chat-message jp-edu-chat-message-${e.role}`;const s="user"===e.role?"ğŸ‘¤":"assistant"===e.role?"ğŸ¤–":"ğŸ“¢",n=this.formatMarkdown(e.content||"...");t.innerHTML=`\n        <div class="jp-edu-message-avatar">${s}</div>\n        <div class="jp-edu-message-content">\n          <div class="jp-edu-message-text">${n}</div>\n          <div class="jp-edu-message-time">${this.formatTime(e.timestamp)}</div>\n        </div>\n      `,this.messagesContainer.appendChild(t)}this.scrollToBottom()}updateLastMessage(e){const t=this.messagesContainer.lastElementChild;if(t){const s=t.querySelector(".jp-edu-message-text");s&&(s.innerHTML=this.formatMarkdown(e))}this.scrollToBottom()}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}setLoading(e){this.sendButton.disabled=e,this.inputElement.disabled=e,this.sendButton.textContent=e?"â³":"ç™¼é€"}getNotebookContext(){const e=this.notebookTracker.currentWidget;if(e)return r.getNotebookContext(e)}dispose(){c===this&&(c=null),super.dispose()}}class u extends i.Widget{constructor(e,t){super(),this.apiClient=e,this.notebookTracker=t,this.addClass("jp-edu-login-widget"),this.statusElement=document.createElement("div"),this.statusElement.className="jp-edu-login-status",this.node.appendChild(this.statusElement),a.subscribe(e=>this.updateUI(e)),this.updateUI(a.getState())}updateUI(e){if(e.isLoggedIn&&e.student){this.statusElement.innerHTML=`\n        <span class="jp-edu-student-info">\n          ğŸ‘¤ ${e.student.name} (${e.student.studentId})\n        </span>\n        <button class="jp-edu-logout-btn" title="ç™»å‡º">ç™»å‡º</button>\n        <button class="jp-edu-config-btn" title="æ“´å±•è¨­å®š">âš™ï¸</button>\n      `;const t=this.statusElement.querySelector(".jp-edu-logout-btn");t&&t.addEventListener("click",()=>this.handleLogout());const n=this.statusElement.querySelector(".jp-edu-config-btn");n&&n.addEventListener("click",async()=>{const{ConfigurationWidget:e}=await s.e(5).then(s.bind(s,5));e.showConfigDialog()})}else{this.statusElement.innerHTML='\n        <button class="jp-edu-login-btn">ğŸ“ å­¸ç”Ÿç™»å…¥</button>\n        <button class="jp-edu-config-btn" title="æ“´å±•è¨­å®š">âš™ï¸</button>\n      ';const e=this.statusElement.querySelector(".jp-edu-login-btn");e&&e.addEventListener("click",()=>this.showLoginDialog());const t=this.statusElement.querySelector(".jp-edu-config-btn");t&&t.addEventListener("click",async()=>{const{ConfigurationWidget:e}=await s.e(5).then(s.bind(s,5));e.showConfigDialog()})}}async showLoginDialog(){console.log("[StudentLoginWidget] showLoginDialog è¢«å‘¼å«");const e=document.querySelector(".jp-edu-global-login-overlay");e&&(e.style.display="none");const t=document.createElement("div");t.className="jp-edu-login-dialog",t.innerHTML='\n      <div class="jp-edu-form-group">\n        <label for="student-id">å­¸è™Ÿ *</label>\n        <input type="text" id="student-id" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" autocomplete="off" />\n      </div>\n      <div class="jp-edu-form-group">\n        <label for="student-name">å§“å *</label>\n        <input type="text" id="student-name" placeholder="è«‹è¼¸å…¥å§“å" autocomplete="off" />\n      </div>\n      <p class="jp-edu-form-note">ç™»å…¥å¾Œå°‡é–‹å§‹è¨˜éŒ„æ‚¨çš„å­¸ç¿’æ­·ç¨‹</p>\n    ';try{if((await(0,n.showDialog)({title:"å­¸ç”Ÿç™»å…¥",body:new i.Widget({node:t}),buttons:[n.Dialog.cancelButton({label:"å–æ¶ˆ"}),n.Dialog.okButton({label:"ç™»å…¥"})]})).button.accept){const e=t.querySelector("#student-id"),s=t.querySelector("#student-name"),o=e?.value.trim()||"",i=s?.value.trim()||"";o&&i?await this.handleLogin(o,i):await(0,n.showDialog)({title:"éŒ¯èª¤",body:"å­¸è™Ÿå’Œå§“åç‚ºå¿…å¡«æ¬„ä½",buttons:[n.Dialog.okButton({label:"ç¢ºå®š"})]})}}finally{e&&!a.isLoggedIn()&&(e.style.display="flex")}}async handleLogin(e,t){const s=this.notebookTracker.currentWidget,o=s?.title.label||"unknown";try{const s=await this.apiClient.login(e,t,o);if(!s.success||!s.session_id)throw new Error(s.error||"ç™»å…¥å¤±æ•—");a.setSession(s.session_id,{studentId:e,name:t},o),await(0,n.showDialog)({title:"ç™»å…¥æˆåŠŸ",body:s.message||"æ­¡è¿ï¼æ‚¨çš„å­¸ç¿’æ­·ç¨‹å°‡è¢«è¨˜éŒ„ã€‚",buttons:[n.Dialog.okButton({label:"é–‹å§‹å­¸ç¿’"})]})}catch(e){console.error("[StudentLoginWidget] ç™»å…¥éŒ¯èª¤:",e),await(0,n.showDialog)({title:"ç™»å…¥å¤±æ•—",body:`${e}`,buttons:[n.Dialog.okButton({label:"ç¢ºå®š"})]})}}async handleLogout(){const e=a.getSessionId();if((await(0,n.showDialog)({title:"ç¢ºèªç™»å‡º",body:"ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ",buttons:[n.Dialog.cancelButton({label:"å–æ¶ˆ"}),n.Dialog.okButton({label:"ç™»å‡º"})]})).button.accept)try{e&&await this.apiClient.logout(e),a.clearSession()}catch(e){console.error("[StudentLoginWidget] ç™»å‡ºéŒ¯èª¤:",e),a.clearSession()}}}class h extends i.Widget{constructor(){super(),this.overlay=null,this.warningShown=!1,this.createOverlay(),a.subscribe(e=>{console.log("[LoginOverlay] æ”¶åˆ°ç‹€æ…‹è®Šæ›´:",e.isLoggedIn),this.updateOverlay(e.isLoggedIn)}),document.addEventListener("edu-extension:require-login",e=>{const t=e;this.showLoginWarning(t.detail.message)})}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="jp-edu-global-login-overlay",this.overlay.style.zIndex="100000",this.overlay.innerHTML='\n      <div class="jp-edu-overlay-content">\n        <div class="jp-edu-overlay-icon">ğŸ”’</div>\n        <h2>è«‹å…ˆç™»å…¥</h2>\n        <p>æ‚¨å¿…é ˆç™»å…¥å¾Œæ‰èƒ½ä½¿ç”¨ Jupyter Notebook</p>\n        <button class="jp-edu-overlay-login-btn">ğŸ“ å­¸ç”Ÿç™»å…¥</button>\n      </div>\n    ';const e=this.overlay.querySelector(".jp-edu-overlay-login-btn");e&&e.addEventListener("click",()=>{console.log("[LoginOverlay] ç™»å…¥æŒ‰éˆ•è¢«é»æ“Š");const e=new CustomEvent("edu-extension:show-login");document.dispatchEvent(e)}),document.body.appendChild(this.overlay);const t=a.isLoggedIn();console.log("[LoginOverlay] åˆå§‹åŒ–ï¼Œç•¶å‰ç™»å…¥ç‹€æ…‹:",t),this.updateOverlay(t)}updateOverlay(e){if(this.overlay){const t=e?"none":"flex";this.overlay.style.display=t,console.log(`[LoginOverlay] æ›´æ–°é¡¯ç¤º: ${t} (å·²ç™»å…¥: ${e})`)}else console.warn("[LoginOverlay] è¦†è“‹å±¤å…ƒç´ ä¸å­˜åœ¨")}async showLoginWarning(e){this.warningShown||(this.warningShown=!0,await(0,n.showDialog)({title:"âš ï¸ è«‹å…ˆç™»å…¥",body:e||"æ‚¨éœ€è¦ç™»å…¥å¾Œæ‰èƒ½åŸ·è¡Œç¨‹å¼ç¢¼ã€‚æ‚¨çš„åŸ·è¡Œçµæœå°‡ä¸æœƒè¢«è¨˜éŒ„ã€‚",buttons:[n.Dialog.okButton({label:"æˆ‘çŸ¥é“äº†"})]}),this.warningShown=!1)}dispose(){this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),super.dispose()}}var g=s(292),p=s(907);class m{constructor(){this.serverSettings=p.ServerConnection.makeSettings(),this.baseUrl=g.URLExt.join(this.serverSettings.baseUrl,"edu-extension","api")}async request(e,t="GET",s){const n=g.URLExt.join(this.baseUrl,e),o={method:t,headers:{"Content-Type":"application/json"}};s&&(o.body=JSON.stringify(s));const i=await p.ServerConnection.makeRequest(n,o,this.serverSettings);if(!i.ok){const e=await i.text();try{const t=JSON.parse(e);if("NOT_LOGGED_IN"===t.error_code)throw new Error("è«‹å…ˆç™»å…¥");throw new Error(t.error||`API è«‹æ±‚å¤±æ•—: ${i.status}`)}catch(t){if(t instanceof Error&&"è«‹å…ˆç™»å…¥"===t.message)throw t;throw new Error(`API è«‹æ±‚å¤±æ•—: ${i.status} ${e}`)}}return i.json()}async healthCheck(){return this.request("health")}async checkLogin(e){return this.request(`auth/check?session_id=${encodeURIComponent(e)}`)}async login(e,t,s){return this.request("auth/login","POST",{student_id:e,name:t,notebook_name:s})}async logout(e){return this.request("auth/logout","POST",{session_id:e})}async trackExecution(e){return this.request("tracking/execution","POST",{session_id:e.sessionId,cell_id:e.cellId,cell_content:e.cellContent,execution_count:e.executionCount,output:e.output,error_output:e.errorOutput,execution_time_ms:e.executionTimeMs})}async analyzeCode(e,t,s,n){return this.request("chatgpt/analyze","POST",{session_id:e,code:t,error:s,context:n})}async chat(e,t,s){return this.request("chatgpt/chat","POST",{session_id:e,message:t,notebook_context:s})}async chatStream(e,t,s,n,o,i){const a=g.URLExt.join(this.baseUrl,"chatgpt/stream");try{const r=document.cookie.split("; ").find(e=>e.startsWith("_xsrf="))?.split("=")[1]||"",l=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":r},body:JSON.stringify({session_id:e,message:t,notebook_context:s}),credentials:"same-origin"});if(!l.ok){const e=await l.text();try{const t=JSON.parse(e);if("NOT_LOGGED_IN"===t.error_code)return void o?.("è«‹å…ˆç™»å…¥");o?.(t.error||"è«‹æ±‚å¤±æ•—")}catch{o?.(`è«‹æ±‚å¤±æ•—: ${l.status}`)}return}const c=l.body?.getReader();if(!c)return void o?.("ç„¡æ³•è®€å–ä¸²æµ");const d=new TextDecoder;let u="";for(;;){const{done:e,value:t}=await c.read();if(e)break;u+=d.decode(t,{stream:!0});const s=u.split("\n");u=s.pop()||"";for(const e of s)if(e.startsWith("data: ")){const t=e.slice(6).trim();if("[DONE]"===t)return void i?.();try{const e=JSON.parse(t);e.chunk?n(e.chunk):e.error&&o?.(e.error)}catch{}}}i?.()}catch(e){o?.(`ç¶²è·¯éŒ¯èª¤: ${e}`)}}async getReport(e){return this.request(`analytics/report?session_id=${encodeURIComponent(e)}`)}}s(966);const y="jupyterlab-edu-extension",b={openChatGPT:`${y}:open-chatgpt`,showLogin:`${y}:show-login`,showReport:`${y}:show-report`,showConfig:`${y}:show-config`},v=[{id:`${y}:main`,autoStart:!0,requires:[o.INotebookTracker],optional:[n.ICommandPalette],activate:async(e,t,n)=>{console.log("[æ•™å­¸æ“´å±•] æ­£åœ¨å•Ÿå‹•...");const o=new m;a.initialize();try{const e=await o.healthCheck();console.log("[æ•™å­¸æ“´å±•] æœå‹™ç‹€æ…‹:",e),e.openai_configured||(console.log("[æ•™å­¸æ“´å±•] OpenAI æœªé…ç½®ï¼Œå°‡é¡¯ç¤ºé…ç½®å°è©±æ¡†"),s.e(5).then(s.bind(s,5)).then(({ConfigurationWidget:e})=>{setTimeout(()=>{e.showConfigDialog()},2e3)}))}catch(e){console.warn("[æ•™å­¸æ“´å±•] ç„¡æ³•é€£æ¥å¾Œç«¯æœå‹™:",e)}const i=new u(o,t);i.id=`${y}-login`,i.title.label="å­¸ç”Ÿç™»å…¥",i.title.closable=!1;const l=new h;console.log("[æ•™å­¸æ“´å±•] LoginOverlay initialized:",l),document.addEventListener("edu-extension:show-login",()=>{i.showLoginDialog()});const c=new r(o);t.widgetAdded.connect((e,t)=>{c.attachToNotebook(t)});const g=new d(o,t);g.id=`${y}-chatgpt`,g.title.label="ğŸ’¬ AI åŠ©æ•™",g.title.closable=!0,e.commands.addCommand(b.openChatGPT,{label:"é–‹å•Ÿ AI åŠ©æ•™",caption:"é–‹å•Ÿ ChatGPT å´é‚Šæ¬„",execute:()=>{g.isAttached||e.shell.add(g,"right"),e.shell.activateById(g.id)}}),e.commands.addCommand(b.showLogin,{label:"å­¸ç”Ÿç™»å…¥",caption:"é¡¯ç¤ºå­¸ç”Ÿç™»å…¥å°è©±æ¡†",execute:()=>{i.showLoginDialog()}}),e.commands.addCommand(b.showConfig,{label:"âš™ï¸ æ“´å±•è¨­å®š",caption:"é–‹å•Ÿæ•™å­¸æ“´å±•è¨­å®šå°è©±æ¡†",execute:async()=>{const{ConfigurationWidget:e}=await s.e(5).then(s.bind(s,5));e.showConfigDialog()}}),n&&(n.addItem({command:b.openChatGPT,category:"æ•™å­¸æ“´å±•"}),n.addItem({command:b.showLogin,category:"æ•™å­¸æ“´å±•"}),n.addItem({command:b.showConfig,category:"æ•™å­¸æ“´å±•"})),e.shell.add(i,"top"),e.shell.add(g,"right"),console.log("[æ•™å­¸æ“´å±•] å•Ÿå‹•å®Œæˆ")}}]}}]);